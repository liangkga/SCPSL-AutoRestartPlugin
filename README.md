# AutoRestartPlugin

一个用于 SCP: Secret Laboratory 的 EXILED 插件，当服务器只剩下一个玩家或没有玩家时自动重启服务器。

## 功能特性

- 🔄 **智能重启**: 当回合只剩下一个玩家或没有玩家时自动重启
- ⚙️ **高度可配置**: 支持自定义检查间隔、重启延迟等参数
- 🛡️ **异常处理**: 内置多层异常处理机制，确保重启功能稳定运行
- 📢 **玩家通知**: 在重启前向玩家发送广播通知
- 🔧 **调试模式**: 支持调试模式，便于问题排查
- 🚀 **双重重启**: 优先使用服务器重启，失败时自动降级到回合重启

## 安装方法

1. 确保你的服务器已安装 [EXILED](https://github.com/Exiled-Team/EXILED) 框架
2. 下载最新版本的 `AutoRestartPlugin.dll`
3. 将 DLL 文件放入服务器的 `EXILED/Plugins` 目录
4. 重启服务器或重新加载插件

## 配置选项

插件配置文件位于 `EXILED/Configs/{服务器端口}-config.yml`，在 `auto_restart_plugin` 部分进行配置：

```yaml
auto_restart_plugin:
  # 是否启用插件
  is_enabled: true
  
  # 是否启用调试模式
  debug: false
  
  # 回合开始后多少秒开始检查玩家数量（避免回合刚开始时的误判）
  check_delay_seconds: 30
  
  # 玩家数量检查间隔（秒）
  check_interval_seconds: 5
  
  # 只剩一个玩家时的重启延迟（秒）
  single_player_restart_delay: 5
  
  # 没有玩家时的重启延迟（秒）
  no_player_restart_delay: 1
  
  # 是否优先使用服务器重启而不是回合重启
  prefer_server_restart: true
  
  # 只剩一个玩家时显示的广播消息
  single_player_message: '<color=yellow>只剩下一个玩家，回合将在{0}秒后自动重启...</color>'
  
  # 广播消息显示时长（秒）
  broadcast_duration: 10
```

## 工作原理

1. **回合开始检测**: 插件在每个回合开始时启动玩家数量监控
2. **延迟检查**: 等待配置的延迟时间后开始检查，避免回合初期的误判
3. **定期监控**: 按配置的间隔定期检查在线玩家数量
4. **触发条件**:
   - 只剩下 1 个玩家：发送广播通知，等待指定时间后重启
   - 没有玩家：直接重启（无通知）
5. **安全重启**: 使用多层异常处理确保重启成功

## 重启策略

插件采用智能重启策略：

1. **优先服务器重启**: 默认使用 `Server.Restart()` 进行完整的服务器重启
2. **异常处理**: 如果服务器重启失败，自动降级到 `Round.Restart()` 回合重启
3. **延迟执行**: 使用 0.1 秒延迟避免网络状态不稳定时的异常
4. **多重备份**: 多层 try-catch 确保在任何情况下都能成功重启

## 兼容性

- **EXILED 版本**: 9.7.1+
- **游戏版本**: SCP: Secret Laboratory 最新版本
- **.NET Framework**: 4.8

## 开发信息

- **作者**: 星浴
- **版本**: 1.0.0
- **许可证**: MIT License

## 问题反馈

如果遇到问题或有功能建议，请：

1. 启用调试模式查看详细日志
2. 检查服务器日志中的错误信息
3. 提交 Issue 并附上相关日志

## 更新日志

### v1.0.0
- 初始版本发布
- 支持基本的玩家数量检查和自动重启功能
- 完整的配置系统
- 异常处理和调试支持
